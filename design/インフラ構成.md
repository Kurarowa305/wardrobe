# インフラ設計資料


## 1. 目的

本資料は、Wardrobe アプリケーションにおける **インフラ構成・Lambda分割方針・命名規則・ローカル開発方式** を明確化し、
実装・Terraform構築・将来の運用判断における共通認識を形成することを目的とする。

---

## 2. 全体アーキテクチャ概要

本システムは、**サーバレス構成**を前提とし、以下のAWSサービスを中心に構成される。

* フロントエンド

  * Amazon S3（静的ホスティング）
  * Amazon CloudFront（CDN）
* バックエンド

  * Amazon API Gateway（HTTP API）
  * AWS Lambda（Node.js 20 / TypeScript）
* データストア

  * Amazon DynamoDB（単一テーブル設計）
* 画像ストレージ

  * Amazon S3（presigned URL 方式で直接アップロード）

---

## 3. Lambda 構成方針（重要）

### 3.1 採用方針

* **複数Lambda構成を採用する**
* 分割単位は以下のルールに従う

### 3.2 分割ルール

1. **画像アップロード（presign）は必ず別Lambda**
2. **業務ドメイン単位でLambdaを分割**

### 3.3 Lambda一覧

| ドメイン     | Lambda名（例：dev環境）               | 主な責務                  |
| -------- | ------------------------------ | --------------------- |
| wardrobe | `wardrobe-dev-wardrobe_server` | ワードローブ作成・取得・設定        |
| clothing | `wardrobe-dev-clothing_server` | 服のCRUD・一覧・論理削除        |
| template | `wardrobe-dev-template_server` | テンプレートCRUD・一覧（服データ同梱） |
| history  | `wardrobe-dev-history_server`  | 履歴CRUD・一覧（服データ同梱）     |
| presign  | `wardrobe-dev-presign_server`  | S3 presigned URL 発行のみ |

---

## 4. Lambda 命名規則

### 命名フォーマット

```
{app}-{env}-{domain}_server
```

### 例

* `wardrobe-dev-clothing_server`
* `wardrobe-prod-presign_server`

### 命名方針の意図

* CloudWatch / Terraform / IAM 一覧で **用途が即座に判別できる**
* 環境・ドメイン・責務が明確
* 将来Lambda数が増えても可読性が落ちない

---

## 5. API Gateway（HTTP API）ルーティング設計

### 基本方針

* **パスプレフィックス単位でLambdaを振り分ける**
* ルート数を増やさず、Terraform管理を簡素にする

### ルーティング例

| パス                            | 統合先Lambda       |
| ----------------------------- | --------------- |
| `/images/presign`             | presign_server  |
| `/wardrobes/*`                | wardrobe_server |
| `/wardrobes/{id}/clothing/*`  | clothing_server |
| `/wardrobes/{id}/templates/*` | template_server |
| `/wardrobes/{id}/histories/*` | history_server  |

---

## 6. IAM設計方針

### presign_server

* S3

  * `s3:PutObject`（presigned URL 発行に必要）
* （必要に応じて）KMS権限

### それ以外の domain Lambda

* DynamoDB

  * `GetItem`
  * `Query`
  * `PutItem`
  * `UpdateItem`
  * `DeleteItem`
  * `BatchGetItem`（template / history）
  * `TransactWriteItems`（整合性確保が必要な場合）

 **S3権限は presign_server のみに付与する**

---

## 7. ロギング・監視設計

### 基本方針

* Lambdaごとに CloudWatch Logs / Metrics を分離
* ドメイン単位で以下を即座に把握可能にする

  * エラー率
  * レイテンシ
  * スロットリング

### ログ設計（全Lambda共通）

* 構造化ログ（JSON）を採用
* 必須項目

  * requestId
  * method
  * path
  * domain
  * wardrobeId
  * statusCode
  * durationMs
  * errorCode

---

## 8. アーキテクチャ思想の整理

### 本構成の位置づけ

* **モジュラーモノリス（分割デプロイ型）**

### 理由

* DynamoDBは単一テーブルで共有
* サービス間通信（HTTP / Event）が存在しない
* 境界は「コード」と「Lambda単位」で明確に分離されている

---

## 9. ローカル開発方式

### 採用方式

* ローカルでは **1つのNode.jsサーバー** を起動
* 本番と同じパス設計で全リクエストを受信
* 内部で domain ごとの handler / usecase に振り分ける

### 設計原則

* ビジネスロジックは Lambda イベントに依存しない
* Lambda / ローカル双方で同じ usecase を呼ぶ
* Lambdaは「アダプタ層」に留める

---

## 10. 共通化ルール

全Lambdaで必ず共通化するもの：

* エラー形式・エラーコード
* cursorページング仕様
* レスポンス整形
* ログ項目

これらは **共通パッケージ（workspace）** として切り出す。

---
