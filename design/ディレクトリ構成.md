## ディレクトリ構成

### リポジトリ直下（モノレポ）

```
wardrobe/
  apps/
    web/                          # Next.js(App Router) + TypeScript（フロント）
    api/                          # Lambda(Node.js/TypeScript) + ローカル統合サーバ（バックエンド）
  packages/
    shared/                       # 共有（型・error・cursor・zod schema等）
    openapi/                      # OpenAPI仕様
  infra/
    terraform/                    # AWS（bootstrap + app）
  docker/
    dynamodb/                     # DynamoDB Local
  .github/
    workflows/                    # CI/CD
  pnpm-workspace.yaml
  package.json
  tsconfig.base.json
  README.md
```

---

## apps/api（バックエンド）

### 要点

* `entry/`：Lambda / local の起動点
* `domains/`：ドメイン実装
* **stats は write と read を分離**

  * **stats write**：履歴トリガーでのみ発生 → **`domains/history/stats_write/`**
  * **stats read**：将来 API として切り出す対象 → **`domains/stats/`**

```
apps/api/
  src/
    entry/
      lambda/
        wardrobe_server.ts
        clothing_server.ts
        template_server.ts
        history_server.ts
        stats_server.ts              # stats read API 用
        presign_server.ts
      local/
        server.ts
        router.ts

    domains/
      wardrobe/
        handlers/
        usecases/
        repo/

      clothing/
        handlers/
        usecases/
        repo/

      template/
        handlers/
        usecases/
        repo/

      history/
        handlers/
          createHistoryHandler.ts
          deleteHistoryHandler.ts
        usecases/
          createHistoryWithStatsWrite.ts    # AP-16（履歴作成 + 統計整合更新）
          deleteHistoryWithStatsWrite.ts    # AP-17（履歴削除 + 再計算 + 統計整合更新）
        repo/
          historyRepo.ts

        stats_write/                         # ★stats write は history 内に閉じる
          types.ts                           # HistoryFact 等
          keys.ts                            # yyyymmdd / yyyy-ww / yyyy-mm
          plan.ts                            # どの集計を更新するか（今はdailyのみでもOK）
          aggregations/
            daily.ts                         # WearDaily / wearCount / lastWornAt（現行）
            weekly.ts                        # 将来
            monthly.ts                       # 将来
          recompute/
            lastWornAt.ts                    # AP-17用
            wearDailyCount.ts                # count==1ならDelete等の分岐
          transact/
            buildItems.ts                    # TransactWriteItems生成
            guard.ts                         # 25件制限など
          repo/
            clothingStatsRepo.ts             # ClothingWearDaily / Clothing の統計更新（更新に限定）
            templateStatsRepo.ts             # TemplateWearDaily / Template の統計更新（更新に限定）
            wearDailyQueryRepo.ts            # 降順Queryなど（再計算に限定）

      stats/                                  # ★stats read（将来のAPI切り出し対象）
        handlers/
          getClothingStatsHandler.ts
          getTemplateStatsHandler.ts
        usecases/
          getClothingTrend.ts                # 週/月推移等
          getNotWornClothing.ts              # 最近着ていない抽出
          getWearSummary.ts                  # 期間内集計・傾向
        queries/
          clothingStatsQueryRepo.ts
          templateStatsQueryRepo.ts
        dto/
          clothingStatsDto.ts
          templateStatsDto.ts

      presign/
        handlers/
        usecases/
        repo/

    core/                                     # 全ドメイン共通（共通基盤のみ）
      errors/
      cursor/
      logging/
      validation/
      response/

    clients/
      dynamodb.ts
      s3.ts

    config/
      env.ts
```

---

## apps/web（フロント）

### 要点

* `app/` はルーティングのみ（薄く）
* **API を叩くのは features（画面ロジック）**
* 通信の詳細は `api/`（fetch + schema + TanStack Query hooks）
* stats 画面は将来 `features/stats` に追加しやすい

```
apps/web/
  src/
    app/
      (tabs)/
        layout.tsx                 # Header + TabBar
        home/page.tsx
        histories/page.tsx
        templates/page.tsx
        clothings/page.tsx
      (stack)/
        record/page.tsx            # 今日着た記録（全画面）
        clothings/new/page.tsx
        clothings/[clothingId]/page.tsx
        clothings/[clothingId]/edit/page.tsx
        templates/new/page.tsx
        templates/[templateId]/page.tsx
        templates/[templateId]/edit/page.tsx
        histories/[historyId]/page.tsx
        wardrobes/new/page.tsx
      layout.tsx                   # AppProviders（QueryProvider等）
      globals.css

    features/
      home/
      histories/
      templates/
      clothings/
      record/
      stats/                       # 将来：統計UI（週/月推移など）

    components/
      ui/                          # shadcn/ui
      app/                         # アプリ共通UI（受け身）
        layout/
          AppHeader.tsx
          TabBar.tsx
          BackButton.tsx
        cards/
          ClothingRow.tsx
          TemplateRow.tsx
          HistoryRow.tsx
        dialogs/
          ConfirmDialog.tsx
        forms/
          TextField.tsx

    api/
      client.ts                    # fetch wrapper
      endpoints/
        wardrobe.ts
        clothing.ts
        template.ts
        history.ts
        stats.ts                   # 将来（read）
      schemas/
        wardrobe.ts
        clothing.ts
        template.ts
        history.ts
        stats.ts
      queryKeys.ts
      hooks/
        wardrobe.ts
        clothing.ts
        template.ts
        history.ts
        stats.ts

    constants/
      commonStrings.ts
      routes.ts

    lib/
      providers/AppProviders.tsx
      queryClient.ts
      error/normalize.ts
      date/
```

---

## 補足：履歴と stats 周り（複雑な部分の整理）

### 1) stats を write / read で分けた意味

* **Write（整合更新）**：履歴作成・削除のトランザクション内で必ず起きる
  → これは **History ユースケースの副作用**として扱うのが最も自然
* **Read（可視化/抽出）**：週別/月別推移、未着用抽出、傾向可視化
  → 将来 **stats API として独立しやすい**（画面も増える）

### 2) “stats write を history の中に閉じる” とは

* **トランザクション（TransactWrite）の実行主体は history**
* `domains/history/stats_write` は

  * 更新対象（WearDaily / wearCount / lastWornAt 等）を整理し
  * TransactWriteItems を組み立てる
  * 削除時の再計算（lastWornAt の次点探索など）を補助する
* **clothing/template の usecase は呼ばない**

  * 統計更新は “統計更新専用Repo” で DynamoDB の更新を行う（循環参照を避ける）

### 3) “stats read は別ドメイン” の扱い

* stats read は **WearDaily / WearWeekly / WearMonthly などの集計アイテム**を参照して

  * 期間推移
  * ランキング
  * 未着用抽出
  * 傾向（期間内集計）
    を提供する想定
* API としては `/stats/*` のようなプレフィックスで `stats_server` に寄せやすい

---

## ADR：Stats の扱いに関する設計判断

### タイトル

**Stats を Write / Read に分離し、Write は History に内包、Read は Stats ドメインとして切り出す**

### 背景 / コンテキスト

* 履歴作成/削除時に、WearDaily や wearCount / lastWornAt（キャッシュ）など、服・テンプレに跨る統計更新が必要
* これらの更新は基本的に **履歴操作と同一トランザクションで整合更新**したい
* 将来、統計要件（週別/月別推移、未着用抽出、傾向可視化）により **stats API を独立させたい**

### 決定（Decision）

1. **Stats は Write と Read を分離する**
2. **Stats Write は History 操作からしか発生しないため、History ドメイン内（`domains/history/stats_write`）に内包する**
3. **Stats Read は将来的に API として独立させるため、`domains/stats` として別ドメインにする**
4. **トランザクション実行主体は History に固定する**
5. Stats Write は clothing/template の usecase を呼ばず、統計更新専用 repo に限定して更新する

### 理由（Rationale）

* **整合性**：履歴操作と統計更新を同一トランザクションで扱いやすい（Write が History 内にある）
* **境界明確化**：Write を stats ドメインにすると「誰がトランザクションを所有するか」が曖昧になりやすい
  → トランザクション所有を History に固定して曖昧さを排除
* **将来拡張**：Read は要求が増えやすく、独立 API にする価値が高い
  → stats read を別ドメインとして育てると切り出しが容易
* **依存の健全性**：clothing/template のビジネスロジックを巻き込まないことで循環参照を避け、変更影響を抑制

### 代替案（Alternatives）

* A) stats を完全に別ドメインにし、write も stats が実行する

  * 欠点：トランザクション所有が曖昧、history との責務重複、境界が溶けやすい
* B) stats をすべて core/stats モジュールに置く

  * 欠点：write が横断利用されやすくなり境界が溶ける／stats API 独立の導線が弱い
* C) stats をすべて history に直書きする（モジュール化しない）

  * 欠点：将来の統計追加で history usecase が肥大化しやすい

### 影響（Consequences）

* ✅ history のユースケースは “整合更新” を担うが、実装は `stats_write` に切り出すため肥大化を抑えられる
* ✅ stats read API を `domains/stats` で育てることで、将来の stats API 切り出しが容易
* ⚠️ stats write/read が分離されるため、集計アイテム（daily/weekly/monthly）の追加時は「write側更新」と「read側参照」の両方に変更が入る
  → ただし責務が明確なので変更箇所は追いやすい

---
