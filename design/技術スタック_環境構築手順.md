# 技術スタック

## フロントエンド

* Next.js（App Router）
* TypeScript
* Tailwind CSS
* shadcn/ui（カード/モーダル/ドロワー等）
* TanStack Query（データ取得・キャッシュ）
* Zod（フォーム入力/レスポンス検証）
* PWA（manifest + Service Worker）

## バックエンド

* AWS Lambda（Node.js 20 / TypeScript）
* API Gateway（HTTP API）
* Zod（リクエスト/レスポンスの境界で検証）

## データストア

* DynamoDB（単一テーブル設計）
    * cursorページング（一覧APIで共通ルール）
* 画像アップロード：S3（presigned URL でクライアント直PUT）

## ホスティング

* S3（静的ファイル格納）
* CloudFront（HTTPS/CDN/キャッシュ）

## IaC / CI/CD

* Terraform（AWSリソース管理）
* GitHub Actions

  * CI：PRで lint/typecheck/build
  * CD：mainで build → deploy

---

# リポジトリ構成

```
wardrobe/
  apps/
    web/              # Next.js (PWA)
    api/              # Lambda (TypeScript)
  packages/
    openapi/          # openapi.yaml
    shared/           # 生成型・共通型
  infra/
    terraform/        # S3/CloudFront/API/Lambda/DDB など
  docker/
    dynamodb/         # DynamoDB Local
  .github/workflows/  # CI/CD
```

---

# 環境構築手順

# 1. ローカル環境にインストール

## 1.1 Git

### macOS

```bash
xcode-select --install
```

### Windows（WSL2）

```bash
sudo apt update
sudo apt install git -y
```

確認：

```bash
git --version
```

---

## 1.2 Node.js 20

### macOS（Homebrew）

```bash
brew install node@20
```

### Windows（WSL2）

```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install nodejs -y
```

確認：

```bash
node -v   # v20.x
```

---

## 1.3 pnpm

```bash
corepack enable
corepack prepare pnpm@latest --activate
pnpm -v
```

---

## 1.4 Docker Desktop

* macOS / Windows 共通
   [https://www.docker.com/products/docker-desktop/](https://www.docker.com/products/docker-desktop/)

インストール後、**Docker を起動**してから確認：

```bash
docker -v
docker compose version
```

---

## 1.5 AWS CLI v2

### macOS

```bash
brew install awscli
```

### Windows（WSL2）

```bash
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o awscliv2.zip
unzip awscliv2.zip
sudo ./aws/install
```

確認：

```bash
aws --version
```

---

## 1.6 Terraform

### macOS

```bash
brew install terraform
```

### Windows（WSL2）

```bash
sudo apt update
sudo apt install -y gnupg software-properties-common curl
```
```bash
curl -fsSL https://apt.releases.hashicorp.com/gpg \
  | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
```
```bash
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
https://apt.releases.hashicorp.com $(lsb_release -cs) main" \
| sudo tee /etc/apt/sources.list.d/hashicorp.list
```
```bash
sudo apt update
sudo apt install -y terraform
```

確認：

```bash
terraform -v
```

---

# 2. AWS アカウント設定

## 2.1 IAM ユーザー作成

AWS Console で以下を作成：

* IAM ユーザー
* 権限（最初は簡易でOK）

  * AdministratorAccess（MVP段階）

---

# 3. プロジェクト作成

## 3.1 リポジトリ作成

```bash
mkdir wardrobe
cd wardrobe
git init
```

---

## 3.2 ディレクトリ構成作成

```bash
mkdir -p apps/web apps/api packages/openapi infra/terraform docker/dynamodb .github/workflows
```

---

## 3.3 pnpm workspace 設定
```bash
pnpm init
```

`pnpm-workspace.yaml`

```yaml
packages:
  - "apps/*"
  - "packages/*"
```

```bash
pnpm install
```

---

# 4. DynamoDB Local

## 4.1 Docker Compose 作成

`docker/dynamodb/docker-compose.yml`

```yaml
services:
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    command: "-jar DynamoDBLocal.jar -sharedDb -inMemory"
    ports:
      - "8000:8000"
```

## 4.2 起動

```bash
docker compose -f docker/dynamodb/docker-compose.yml up -d
```

確認：

```bash
aws dynamodb list-tables --endpoint-url http://localhost:8000
```

---

# 5. バックエンド

## 5.1 初期化

```bash
cd apps/api
pnpm init
pnpm add zod
pnpm add -D typescript tsx @types/node eslint
npx tsc --init
```

## 5.2 環境変数

```bash
touch .env.local
```

`apps/api/.env.local`

```
AWS_REGION=ap-northeast-1
DDB_ENDPOINT=http://localhost:8000
S3_BUCKET=wardrobe-dev-images
```

```bash
touch ../../.gitignore
```
`wardrobe/.gitignore`
```
.env.local
```

## 5.3 最低限の依存関係用意
`apps/api/src`
```bash
mkdir -p src
```

```bash
cat > src/index.ts << 'EOF'
import dotenv from "dotenv";

dotenv.config({ path: ".env.local" });

console.log("API starting...");
console.log({
  region: process.env.AWS_REGION,
  ddb: process.env.DDB_ENDPOINT,
  bucket: process.env.S3_BUCKET,
});

// 仮：起動確認用にプロセスを止めない
setInterval(() => {}, 1000);
EOF
```

```bash
pnpm add dotenv
pnpm add -D tsx typescript @types/node
```
`apps/api/package.json`追記
```json
"type": "module",
"scripts": {
    "dev": "tsx watch src/index.ts"
  }
```
`apps/api/tsconfig.json`compilerOptions.typesにnodeを追加
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "CommonJS",
    "moduleResolution": "Node",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,

    "types": ["node"]
  }
}
```
TS Server再起動
* Ctrl + Shift + P
* TypeScript: Restart TS Server

## 5.4 起動（ローカル）

```bash
pnpm dev
```

※ ローカルでは **Node.js サーバーとして起動**（Lambdaは使わない）

5.5 確認
```
API starting...
{
  region: 'ap-northeast-1',
  ddb: 'http://localhost:8000',
  bucket: 'wardrobe-dev-images'
}
```

---

# 6. フロントエンド（Web / PWA）

## 6.1 Next.js 作成

```bash
cd ../../apps/web
pnpm create next-app@latest .
```

選択肢：

* TypeScript → Yes
* App Router → Yes
* Tailwind → Yes

---

## 6.2 環境変数

`apps/web/.env.local`

```
NEXT_PUBLIC_API_BASE_URL=http://localhost:3001
```

---

## 6.3 起動

```bash
pnpm dev
```

 [http://localhost:3000](http://localhost:3000) が表示されればOK

---

# 7. PWA 最小構成

## 7.1 manifest

`apps/web/public/manifest.webmanifest`

```json
{
  "name": "Wardrobe",
  "short_name": "Wardrobe",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#000000",
  "icons": [
    { "src": "/icons/192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "/icons/512.png", "sizes": "512x512", "type": "image/png" }
  ]
}
```

## 7.2 アイコン

```bash
mkdir -p apps/web/public/icons
# 192.png / 512.png を配置
```

---

# 8. AWS 環境（Terraform）
## 8.1 共通設定
| 項目              | 設定                                                     |
| --------------- | ------------------------------------------------------ |
| 環境名             | `dev`                                                  |
| リージョン           | `ap-northeast-1`                                       |
| 命名プレフィックス       | `wardrobe-dev-`                                        |
| タグ              | `Project=wardrobe` / `Env=dev` / `ManagedBy=terraform` |
| Terraform apply | **CI（GitHub Actions）のみ**                               |
| Terraform state | **S3管理 / DynamoDBロックなし**                               |

## 8.2 terraform state管理
| 項目          | 設定                                         |
| ----------- | ------------------------------------------ |
| サービス        | S3                                         |
| バケット名       | `wardrobe-dev-tfstate`                     |
| 用途          | Terraform state 保存                         |
| key         | `terraform/wardrobe/dev/terraform.tfstate` |
| バージョニング     | ON                                         |
| 暗号化         | **SSE-S3**                                 |
| パブリックアクセス   | Block Public Access ON                     |
| アクセス主体      | CI用IAMロールのみ                                |
| DynamoDBロック | **使用しない**                                  |

## 8.3 Web配信
| 項目        | 設定                     |
| --------- | ---------------------- |
| サービス      | S3                     |
| バケット名     | `wardrobe-dev-web`     |
| 用途        | Web静的ファイル配置            |
| 公開設定      | 非公開                    |
| 暗号化       | SSE-S3                 |
| パブリックアクセス | Block Public Access ON |

| 項目     | 設定                         |
| ------ | -------------------------- |
| サービス   | CloudFront                 |
| 用途     | Web配信                      |
| オリジン   | `wardrobe-dev-web`（S3）     |
| S3アクセス | OAC（Origin Access Control） |
| 独自ドメイン | **使用しない**                  |
| 証明書    | CloudFrontデフォルト            |
| プロトコル  | HTTPSのみ                    |
| キャッシュ  | デフォルト設定                    |
| ログ     | OFF（必要になれば追加）              |

## 8.4 画像ストレージ&配信
| 項目        | 設定                                   |
| --------- | ------------------------------------ |
| サービス      | S3                                   |
| バケット名     | `wardrobe-dev-images`                |
| 用途        | 画像保存                                 |
| 公開設定      | 非公開                                  |
| 暗号化       | **SSE-S3**                           |
| パブリックアクセス | Block Public Access ON               |
| CORS      | PUT / GET / HEAD |

| 項目     | 設定                        |
| ------ | ------------------------- |
| サービス   | CloudFront                |
| 用途     | 画像配信                      |
| オリジン   | `wardrobe-dev-images`（S3） |
| S3アクセス | OAC                       |
| 配信URL  | CloudFrontデフォルトドメイン       |
| 署名URL  | 使用しない（将来検討）               |

## 8.5 API
| 項目   | 設定                                 |
| ---- | ---------------------------------- |
| サービス | API Gateway                        |
| 種別   | HTTP API                           |
| API名 | `wardrobe-dev-http-api`            |
| 公開   | 認証なし                               |
| CORS | CloudFront(web) + localhost（devのみ） |
| ログ   | CloudWatch Logs ON                 |

| 項目            | 設定                                                        |
| ------------- | --------------------------------------------------------- |
| サービス          | Lambda                                                    |
| 関数名           | `wardrobe-dev-api`                                        |
| Runtime       | Node.js 20.19.6                                              |
| Memory        | 256 MB                                                    |
| Timeout       | 10 秒                                                      |
| Log retention | 14 日                                                      |

| 項目         | 設定                                                    |
| ---------- | ----------------------------------------------------- |
| サービス       | IAM                                                   |
| 対象         | Lambda実行ロール                                           |
| DynamoDB権限 | Get / Put / Update / Query / BatchGet / TransactWrite |
| S3権限       | presigned URL 発行用（PutObject 等、prefix制限）               |
| Logs権限     | CloudWatch Logs 出力                                    |

## 8.6 データベース
| 項目    | 設定                           |
| ----- | ---------------------------- |
| サービス  | DynamoDB                     |
| テーブル名 | `wardrobe-dev-WardrobeTable` |
| PK    | `PK`（string）                 |
| SK    | `SK`（string）                 |
| 課金モード | オンデマンド（PAY_PER_REQUEST）  |
| GSI   | 設計書どおり 4本                    |
| PITR  | ON                           |
| 削除保護  | OFF（devのため）                  |

## 8.7 初期化

```bash
cd infra/terraform
terraform init
terraform workspace new dev
terraform workspace select dev
```

## 8.8 ディレクトリ構成
```
wardrobe/
├─ infra/
│  └─ terraform/
│     ├─ bootstrap/                  # tfstate用S3を作る（最初だけ）
│     │  ├─ main.tf
│     │  ├─ variables.tf
│     │  ├─ outputs.tf
│     │  └─ versions.tf
│     │
│     ├─ env/
│     │  └─ dev.tfvars              # devのみなのでここに集約
│     │
│     ├─ app/                        # アプリ本体（API / DDB / S3 / CF）
│     │  ├─ main.tf
│     │  ├─ variables.tf
│     │  ├─ locals.tf
│     │  ├─ outputs.tf
│     │  ├─ versions.tf
│     │  ├─ backend.tf               # S3 backend（tfstateバケット作成後に有効）
│     │  │
│     │  ├─ providers.tf             # aws provider
│     │  ├─ iam.tf                   # CIロール / Lambda実行ロール など
│     │  ├─ dynamodb.tf              # WardrobeTable + GSI
│     │  ├─ s3_web.tf                # webバケット
│     │  ├─ s3_images.tf             # imagesバケット + CORS
│     │  ├─ cloudfront_web.tf        # web配信CF + OAC
│     │  ├─ cloudfront_images.tf     # images配信CF + OAC
│     │  ├─ lambda.tf                # Lambda（nodejs20、環境変数など）
│     │  └─ apigw_http_api.tf        # HTTP API + CORS（CFドメインのみ）
│     │
│     └─ modules/                    # 再利用部品（必要になったら）
│        ├─ cloudfront_s3_oac/
│        │  ├─ main.tf
│        │  ├─ variables.tf
│        │  └─ outputs.tf
│        ├─ s3_private_bucket/
│        │  ├─ main.tf
│        │  ├─ variables.tf
│        │  └─ outputs.tf
│        └─ http_api_lambda/
│           ├─ main.tf
│           ├─ variables.tf
│           └─ outputs.tf
```

```bash
mkdir -p {bootstrap,env,app,modules/{cloudfront_s3_oac,s3_private_bucket,http_api_lambda}}
```
```bash
touch bootstrap/{main.tf,variables.tf,outputs.tf,versions.tf}
touch env/dev.tfvars
touch app/{main.tf,variables.tf,locals.tf,outputs.tf,versions.tf,backend.tf,providers.tf,iam.tf,dynamodb.tf,s3_web.tf,s3_images.tf,cloudfront_web.tf,cloudfront_images.tf,lambda.tf,apigw_http_api.tf}
```


---

# 9. Webホスティング（S3 + CloudFront）

## 9.1 ビルド

```bash
pnpm --filter web build
```

## 9.2 S3 へ配置

```bash
aws s3 sync apps/web/out s3://wardrobe-dev-web
```

## 9.3 CloudFront キャッシュ無効化

```bash
aws cloudfront create-invalidation \
  --distribution-id XXXXX \
  --paths "/*"
```

---

# 10. CI/CD（GitHub Actions）

| 項目           | 設定                                        |
| ------------ | ----------------------------------------- |
| Terraform 実行 | plan / apply ともに CI                       |
| 同時実行防止       | concurrency: `wardrobe-dev-terraform`     |
| AWS認証        | GitHub OIDC → IAM Role Assume             |
| Webデプロイ      | build → S3 sync → CloudFront invalidation |
| 手動操作         | 原則なし（確認用途のみ）                              |


---

# 11. 作業時手順

```bash
# DB
docker compose -f docker/dynamodb/docker-compose.yml up -d

# API
cd apps/api && pnpm dev

# Web
cd apps/web && pnpm dev
```

---

## 補足1. Terraform 実行方針について

本プロジェクトでは、**Terraform の `apply` は CI（GitHub Actions）のみで実行する**。
ローカル環境からの `terraform apply` は禁止とし、**ローカルでは `terraform plan` まで**を許可する。

### 目的

* インフラ変更の履歴を CI に集約するため
* state 競合・意図しない apply を防止するため

---

## 補足2. Terraform state 管理方針

### state の保存先

Terraform の state は **S3 backend** を使用して管理する。

* backend: S3
* 暗号化方式: **SSE-S3**
* DynamoDB による state ロックは **使用しない**

```hcl
terraform {
  backend "s3" {
    bucket = "wardrobe-dev-tfstate"
    key    = "terraform/wardrobe/dev/terraform.tfstate"
    region = "ap-northeast-1"
  }
}
```

### 注意事項（ロック無し運用）

DynamoDB ロックを使用しないため、**同時に `terraform apply` が実行されないようにする必要がある**。

そのため、以下を必須ルールとする。

* `terraform apply` は CI のみで実行する
* CI 側で **同時実行制御（concurrency）を必ず設定する**

---

## 補足3. GitHub Actions における concurrency 設定

Terraform の state ロックを DynamoDB で行わない代替として、
GitHub Actions の **concurrency 機能**を使用し、同一環境の apply を直列化する。

### 設定例

```yaml
concurrency:
  group: wardrobe-dev-terraform
  cancel-in-progress: false
```

* `group` は環境単位（dev）で固定する
* これにより、同時に複数の `apply` が走ることを防ぐ

---

## 補足4. 画像ストレージと配信の構成について

### 本番（dev AWS 環境）

* 画像は **S3 に保存**
* 配信は **CloudFront 経由**で行う
* S3 バケットは非公開とし、CloudFront（OAC）からのみアクセス可能とする

### ローカル開発時

ローカル開発では、**S3 を直接使用せず mock 実装に切り替えることを許可する**。

そのため、以下の環境変数でストレージ実装を切り替える。

例：

```env
STORAGE_DRIVER=local
IMAGE_PUBLIC_BASE_URL=http://localhost:4000/images
```

AWS 環境では：

```env
STORAGE_DRIVER=s3
IMAGE_PUBLIC_BASE_URL=https://<images-cloudfront-domain>
```

---
